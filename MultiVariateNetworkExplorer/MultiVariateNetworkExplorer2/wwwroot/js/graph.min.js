let graph=null,currentGraph=null,store=null,dataStore=null,filterNodeList=[],linkedByIndex={},attributefilter={},node=null,link=null,selectionGraph=null,selectionNode=null,selectionLink=null,selectionDraw=null,rect=null,gBrushHolder=null,gBrush=null,brushMode=!1,brushing=!1,brush=null,gDraw=null,gNodes=null,gMain=null,nodeGroups=null,nodeText=null,grads=null,transformX=0,transformY=0,scaleK=1;const simulationDurationInMs=2e4;let startTime=null,endTime=null;const jsPath="../js/PropertyWorkers/";let width=d3.select("#networkGraph svg").node().parentNode.clientWidth,height=d3.select("#networkGraph svg").node().parentNode.clientHeight;const svg=d3.select("#networkGraph svg");let selectionSvg=null,selectionSimulation=d3.forceSimulation().force("link",d3.forceLink()).force("charge",d3.forceManyBody()).force("collide",d3.forceCollide()).force("center",d3.forceCenter()).force("forceX",d3.forceX()).force("forceY",d3.forceY());const palette=["#FF355E","#FD5B78","#FF6037","#FF9966","#FF9933","#FFCC33","#FFFF66","#CCFF00","#66FF66","#AAF0D1","#50BFE6","#FF6EFF","#EE34D2","#FF00CC","#FF3855","#FD3A4A","#FB4D46","#FA5B3D","#FFAA1D","#FFF700","#299617","#A7F432","#2243B6","#5DADEC","#5946B2","#9C51B6","#A83731","#AF6E4D","#1B1B1B","#BFAFB2","#FF5470","#FFDB00","#FF7A00","#FDFF00","#87FF2A","#0048BA","#FF007C","#E936A7"],groupColours=d3.scaleOrdinal().range(palette),xScale=d3.scaleLinear().domain([0,width]).range([0,width]),yScale=d3.scaleLinear().domain([0,height]).range([0,height]);let selectedNode=null,shiftKey=null;const nodeVisualProperties={sizing:{enabled:!1,attribute:""},colouring:{network:"#FFFFFF",background:"#000000"},attributeColouring:{enabled:!1,attribute:"",lowValue:"#0000FF",highValue:"#FF0000"},labels:{enabled:!0,attribute:"id"}},prepareLinks=function(){link=gDraw.append("g").attr("class","links").selectAll("path").data(currentGraph.links).enter().append("path").style("display","none");link.append("title").text(function(l){return l.id})},prepareNodes=function(){gNodes=gDraw.append("g").attr("class","nodes").attr("id","nodes").selectAll("circle").data(currentGraph.nodes);nodeGroups=gNodes.enter().append("g").attr("class","node-group").style("display","none").call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));node=nodeGroups.append("circle").attr("r",currentGraph.getForcePropertyValue("collide","radius")).on("mouseover",nodeMouseOver(.2)).on("mouseout",mouseOut);currentGraph.updateSimulationEnd(simulationEnd)},prepareText=function(){nodeText=nodeGroups.append("text").text(function(d){return d.id}).attr("id",function(d){return d.id+"_node_text"}).attr("text-anchor","middle").on("mouseover",nodeMouseOver(.2)).on("mouseout",mouseOut);const radius=currentGraph.getForcePropertyValue("collide","radius");setNodeFontSize(radius)},setNodeFontSize=function(r=null){nodeText.attr("font-size",function(d){const resultR=r===null?d.r:r;return resultR*.85}).attr("dy",function(d){const resultR=r===null?d.r:r;return resultR/3})},prepareBrush=function(){gBrushHolder=gMain.append("g");brushMode=!1;brushing=!1;brush=d3.brush().extent([[0,0],[width,height]]).on("start",brushstarted).on("brush",brushed).on("end",brushended)},prepareZoom=function(){const zoom=d3.zoom().on("zoom",zoomed);gMain.call(zoom)},prepareNetworkBackground=function(){rect=gMain.append("rect").attr("class","background").attr("id","network-background-rect").attr("width","100%").attr("height","100%").on("click",deselectAllNodes)},prepareCanvas=function(){svg.selectAll(".g-main").remove();gMain=svg.append("g").classed("g-main",!0);prepareNetworkBackground();gDraw=gMain.append("g");prepareBrush();prepareZoom();d3.select("body").on("keydown",keydown);d3.select("body").on("keyup",keyup)},drawNetwork=function(){prepareLinks();prepareNodes();prepareText()},createDataGraphObjects=function(data){const{graph:init_graph,data:nodeData}=data;dataStore=new DataStore(nodeData);currentGraph=new Graph(init_graph,dataStore,width,height)},initGraph=function(data){prepareCanvas();createDataGraphObjects(data);drawNetwork(data);updateForces();updateNodeAndLinkColour(node,link)},drawSelectionNetwork=function(data){selectionGraph=data;selectionSvg=d3.select("#selectionGraph svg").attr("width",width).attr("height",height);selectionSvg.selectAll(".g-main").remove();let selectionMain=selectionSvg.append("g").classed("g-main",!0),zoom=d3.zoom().on("zoom",selectionZoomed);selectionMain.call(zoom);let selectionRect=selectionMain.append("rect").attr("width",width).attr("height",height).style("fill","#1A1A1A");selectionDraw=selectionMain.append("g");selectionLink=selectionDraw.append("g").attr("class","links").selectAll("path").data(selectionGraph.links).enter().append("path").attr("id",function(l){return"selection_link_"+l.source+"-"+l.target});selectionLink.append("title").text(function(l){return l.value});selectionNode=selectionDraw.append("g").attr("class","nodes").selectAll("circle").data(selectionGraph.nodes).enter().append("circle").style("fill",function(d){return groupColours(d.id)}).attr("r",function(d){const radius=currentGraph.getForcePropertyValue("collide","radius");return radius+Math.sqrt(d.nonodes)}).attr("id",function(d){return"selection_node_"+d.id});selectionNode.append("title").text(function(d){return"Number of Nodes: "+d.nonodes});selectionSimulation.nodes(selectionGraph.nodes).on("tick",selectionTicked);updateSelectionForces()},fadeDisconnectedNodes=function(nodeId,opacity){node.attr("r",function(d){return nodeId===d.id?d.r*2:d.r});node.style("stroke-opacity",function(o){return this.Opacity=currentGraph.isConnected(nodeId,o.id)?1:opacity,this.Opacity});node.style("fill-opacity",function(o){return this.Opacity=currentGraph.isConnected(nodeId,o.id)?1:opacity,this.Opacity});link.style("stroke-opacity",function(o){return o.source.id===nodeId||o.target.id===nodeId?1:opacity})},nodeMouseOver=function(opacity){return function(d){fadeDisconnectedNodes(d.id,opacity)}},mouseOut=function(){node.attr("r",function(d){return d.r});node.style("stroke-opacity",1);node.style("fill-opacity",1);link.style("stroke-opacity",1)},dragstarted=function(d){d3.event.active||d.selected||shiftKey||nodeGroups.classed("selected",function(p){return p.selected=p.previouslySelected=!1});d3.select(this).classed("selected",!0);d.previouslySelected=d.selected;d.selected=!0;node.each(function(d){d.fx=d.x;d.fy=d.y})},dragged=function(){const{dx,dy}=d3.event;d3.selectAll(".selected").each(function(d){d.x+=dx;d.y+=dy;d.fx+=dx;d.fy+=dy});ticked()},dragended=function(d){d3.event.active||currentGraph.simulation.alphaTarget(0);const{id:nodeId,index:nodeIndex}=d;toggleNodeDetails(nodeId,nodeIndex);showNodeNeighbors(nodeId)},brushstarted=function(){brushing=!0;node.each(function(d){d.previouslySelected=shiftKey&&d.selected})},brushed=function(){if(d3.event.sourceEvent&&d3.event.selection){const extent=d3.event.selection,[[left,top],[right,bottom]]=extent;nodeGroups.classed("selected",function(d){const{previouslySelected,x,y}=d;return d.selected=previouslySelected|(left<=x*scaleK+transformX&&x*scaleK+transformX<right&&top<=y*scaleK+transformY&&y*scaleK+transformY<bottom),d.selected})}},brushended=function(){d3.event.sourceEvent&&d3.event.selection&&gBrush&&(gBrush.call(brush.move,null),brushMode||(gBrush.remove(),gBrush=null),brushing=!1)},keydown=function(){if(shiftKey=d3.event.ctrlKey,shiftKey){if(gBrush)return;brushMode=!0;gBrush||(gBrush=gBrushHolder.append("g"),gBrush.call(brush))}},keyup=function(){(shiftKey=!1,brushMode=!1,gBrush)&&(brushing||(gBrush.remove(),gBrush=null))},deselectAllNodes=function(){node.each(function(d){d.selected=!1;d.previouslySelected=!1});nodeGroups.classed("selected",function(d){return d.selected=d.previouslySelected=!1})},zoomed=function(){const{x,y,k}=d3.event.transform;transformX=x;transformY=y;scaleK=k;gDraw.attr("transform","translate("+transformX+","+transformY+") scale("+scaleK+")")},selectionZoomed=function(){selectionDraw.attr("transform",d3.event.transform)},updateForces=function(reset=true){node.each(function(d){d.fx=null;d.fy=null});updateCenterForce();updateChargeForce();updateCollideForce();updateLinkForce();reset&&currentGraph.resetSimulation()},updateCenterForce=function(){currentGraph.updateCenterForce()},updateChargeForce=function(){currentGraph.updateChargeForce()},updateCollideForce=function(){currentGraph.updateCollideForce();const radius=currentGraph.getForcePropertyValue("collide","radius");if(nodeVisualProperties.sizing.enabled){node.attr("r",function(d){const previousRadius=currentGraph.getForcePropertyValue("collide","radius"),resultRadius=(d.r-1)/previousRadius*radius+1;return d.r=resultRadius});return}node.attr("r",function(d){return d.r=radius})},updateLinkForce=function(){currentGraph.updateLinkForce();const linksEnabled=currentGraph.getForcePropertyValue("link","enabled");link.attr("stroke-width",linksEnabled?1:.5).attr("opacity",linksEnabled?1:0)},updateSelectionForces=function(){const forceProperties=currentGraph.forces,{x,y}=forceProperties.center;selectionSimulation.force("center").x(width*x).y(height*y);const{strength:chargeStrength,enabled:chargeEnabled,distanceMin,distanceMax}=forceProperties.charge;selectionSimulation.force("charge").strength(chargeStrength*chargeEnabled).distanceMin(distanceMin).distanceMax(distanceMax);const{strength:collideStrength,enabled:collideEnabled,radius,iterations:collideIterations}=forceProperties.collide;selectionSimulation.force("collide").strength(collideStrength*collideEnabled).radius(radius).iterations(collideIterations);selectionSimulation.force("forceX").strength(forceProperties.forceX.strength*forceProperties.forceX.enabled).x(width*forceProperties.forceX.x);selectionSimulation.force("forceY").strength(forceProperties.forceY.strength*forceProperties.forceY.enabled).y(height*forceProperties.forceY.y);const{enabled:linksEnabled,distance,iterations:linkIterations}=forceProperties.link;selectionSimulation.force("link").id(function(d){return d.id}).distance(distance*5).iterations(linkIterations).links(linksEnabled?selectionGraph.links:[]);selectionSimulation.alpha(1).restart()},ticked=function(){nodeGroups.attr("transform",positionNode);link.attr("d",positionLink)},simulationEnd=function(){nodeGroups.attr("transform",positionNode);link.attr("d",positionLink);link.style("display","block");nodeGroups.style("display","block");const rootSvgSize=svg.node().getBoundingClientRect(),gDrawSize=gDraw.node().getBoundingClientRect(),x=rootSvgSize.x-gDrawSize.x+(rootSvgSize.width-gDrawSize.width)/2,y=rootSvgSize.y-gDrawSize.y+(rootSvgSize.height-gDrawSize.height)/2;gDraw.attr("transform","translate("+x+","+y+")");currentGraph.stopSimulation()},positionLink=function(d){const{x:sourceX,y:sourceY}=d.source,{x:targetX,y:targetY}=d.target;let x1=sourceX,y1=sourceY,x2=targetX,y2=targetY;const midpoint_x=(x1+x2)/2,midpoint_y=(y1+y2)/2,dx=x2-x1,dy=y2-y1,normalise=Math.sqrt(dx*dx+dy*dy);if(x1===x2&&y1===y2)return x2=x2+1,y2=y2+1,"M"+sourceX+","+sourceY+"A10,10 -45,1,1 "+x2+","+y2;const offSetX=midpoint_x,offSetY=midpoint_y;return"M"+sourceX+","+sourceY+" "+targetX+","+targetY},positionNode=function(d){return"translate("+d.x+","+d.y+")"},selectionTicked=function(){selectionNode.attr("transform",positionNode);selectionLink.attr("d",positionLink)},updateNodeColour=function(nodes){nodes.style("fill",function(d){const{id}=d,colour=getNodeColour(id),lightness=fontLightness(colour),nodeHeading=$("#heading-"+id),text=$("#"+id+"_node_text");return nodeHeading.css("backgroundColor",colour),nodeHeading.css("color","hsl(0, 0%, "+String(lightness)+"%)"),text.css("fill","hsl(0, 0%, "+String(lightness)+"%)"),colour})},updateLinkColour=function(links){links.style("stroke",function(l){const{id}=l.source;return getNodeColour(id)})},updateHeadingColour=function(nodes){for(const d of nodes){const{id}=d,colour=getNodeColour(id),lightness=fontLightness(colour),nodeHeading=$("#heading-"+id);nodeHeading.css("backgroundColor",colour);nodeHeading.css("color","hsl(0, 0%, "+String(lightness)+"%)")}},getNodeColour=function(nodeId){const partition=currentGraph.getPartition(nodeId);if(partition!==""){const partitionWithoutWhitespaces=partition.replace(/[\s,]+/g,"-"),colour_input_name="selection_color_"+partitionWithoutWhitespaces,colour_input=document.getElementById(colour_input_name);return colour_input.value}return nodeVisualProperties.colouring.network},updateNodes=function(){nodeGroups=nodeGroups.data(currentGraph.nodes);nodeGroups.exit().remove();const newNodeGroups=nodeGroups.enter().append("g").attr("class","node-group").call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended)),newNode=newNodeGroups.append("circle").attr("r",currentGraph.getForcePropertyValue(Graph.forceNames.collide,"radius")).on("mouseover",nodeMouseOver(.2)).on("mouseout",mouseOut),newNodeText=newNodeGroups.append("text").text(function(d){return d.id}).attr("id",function(d){return d.id+"_node_text"}).attr("text-anchor","middle").on("mouseover",nodeMouseOver(.2)).on("mouseout",mouseOut);nodeGroups=nodeGroups.merge(newNodeGroups);node=nodeGroups.select("circle");nodeText=nodeGroups.select("text")},updateLinks=function(){link=link.data(currentGraph.links,function(d){d.source});link.exit().remove();const newLink=link.enter().append("path");link=link.merge(newLink);currentGraph.updateLinkForce()},updateNodesAndLinks=function(){updateNodes();updateLinks();const sizingSelect=document.getElementById("attribute-node-sizing");setAttributeNodeSizing(sizingSelect);const colouringSelect=document.getElementById("attribute-node-colouring");setAttributeNodeColouring(colouringSelect);const labelSelect=document.getElementById("node-label-select");setNodeLabel(labelSelect)},updateNodeAndLinkColour=function(nodes,links){nodeVisualProperties.attributeColouring.enabled||(updateNodeColour(nodes),updateLinkColour(links))},updateSelectionNodesAndLinks=function(){const{nodes,links}=selectionGraph;selectionNode=selectionNode.data(nodes,function(d){return d.id});selectionNode.exit().remove();const newNode=selectionNode.enter().append("circle").style("fill",function(d){return groupColours(d.id)}).attr("r",function(d){return Math.sqrt(d.nonodes)}).attr("id",function(d){return"selection_node_"+d.id});newNode.append("title").text(function(d){return"Number of Nodes: "+d.nonodes});selectionNode=selectionNode.merge(newNode);selectionLink=selectionLink.data(links,function(d){d.source});selectionLink.exit().remove();const newLink=selectionLink.enter().append("path").attr("id",function(l){const{source,target}=l;return"selection_link_"+source+"-"+target});newLink.append("title").text(function(l){return l.value});selectionLink=selectionLink.merge(newLink);selectionSimulation.nodes(nodes).on("tick",selectionTicked);selectionSimulation.force("link").links(links);selectionSimulation.alpha(1).restart()},getGraphProperty=function(graph,metricDiv){const metricDivSpan=metricDiv.querySelector("span"),functionName=metricDiv.getAttribute("data-value");metricDivSpan.innerHTML="Calculating...";const result=eval(functionName);metricDivSpan.innerHTML=result},calculateMetricAsync=function(current_graph,metricDiv){const metricDivSpan=metricDiv.querySelector("span");metricDivSpan.innerHTML="Calculating...";const workerName=metricDiv.getAttribute("data-value"),worker=new Worker(jsPath+workerName+"_worker.js?v=5"),data={graph:currentGraph.graph};worker.postMessage(data);worker.onmessage=e=>{metricDivSpan.innerHTML=e.data.average.toFixed(3);currentGraph.setProperties(workerName,e.data);const nodeDetailElement=document.getElementById("node-detail-container"),nodeId=nodeDetailElement.getAttribute("data-id"),metricDisplayElement=nodeDetailElement.querySelector("#display-"+workerName);metricDisplayElement!==null&&(metricDisplayElement.value=currentGraph.getPropertyValue(nodeId,workerName))}},calculateAllMetrics=function(){const syncMetricsDivs=document.querySelectorAll(".network-metric-sync-content");for(let metricDiv of syncMetricsDivs)getGraphProperty(graph,metricDiv)};d3.select(window).on("resize",function(){width=+svg.node().getBoundingClientRect().width;height=+svg.node().getBoundingClientRect().height;currentGraph.updateForces();updateSelectionForces()});$(function(){$('[data-toggle="tooltip"]').tooltip()});